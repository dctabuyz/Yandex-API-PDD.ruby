#!/usr/bin/env ruby

require 'rubygems'
require 'readline'
include Readline
require 'YandexPDD'

token     = ''
cert_file = ''

f = open(ENV['HOME'] + '/.yandex_pdd_token')

f.each do |line|

    line.chomp!.strip!

    token     = $1 if (line =~ /token\s*:\s*(\S+)/)
    cert_file = $1 if (line =~ /cert_file\s*:\s*(.+)/)
end

f.close

exit unless token

user = ARGV[0] || ''
pass = ARGV[1] || ''

while (0 == user.length) do

    user = readline('username: ', true)
end

while (0 == pass.length) do

    pass = readline('password: ', true)
end

pdd = Yandex::PDD::new( token, cert_file )

exit unless pdd

if pdd.create_user(user, pass)

    puts 'user "' + user + '" created'
else

    puts 'error: ' + pdd.error[:code] + ' (' + pdd.error[:info] + ')'
end
